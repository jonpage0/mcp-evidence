# Evidence.dev MCP Server Implementation Plan

## Objectives

- Create an MCP server that interfaces with Evidence.dev project data sources
- Provide read-only access to .parquet files generated by Evidence after running `pnpm run sources`
- Support querying the data using DuckDB's read_parquet and sql() functionality
- Automatically discover all sources and cached parquet files in an Evidence project
- Use Evidence-specific naming conventions for the MCP tools

## Current Architecture Understanding

The existing DuckDB MCP server:
- Uses a specific DuckDB database file as its data source
- Supports both read and write operations
- Provides basic tools for querying and manipulating the database
- Has a simple configuration system for specifying the database path and read-only mode

## Evidence.dev Data Structure

Based on our investigation:
- Evidence.dev processes SQL files from the `/sources` directory
- After running `pnpm run sources`, data is available as parquet files in `.evidence/template/static/data`
- Each source has its own directory with parquet files and schema JSON files
- The `manifest.json` file catalogs all available data sources and their parquet files

## Modified Architecture

```mermaid
graph TD
    subgraph "Evidence Project"
        S[/sources] --> |pnpm run sources| P[.evidence/template/static/data]
        P --> |Contains| PF[Parquet Files]
        P --> |Contains| SF[Schema Files]
    end
    
    subgraph "MCP Server"
        C[Configuration] --> |Project Path| D[Data Discovery]
        D --> |Scans| P
        D --> |Parses| SF
        D --> M[Manifest]
        
        DI[DuckDB Interface] --> |Queries| PF
        
        subgraph "MCP Tools"
            LS[evidence-list-sources]
            LT[evidence-list-tables] 
            DT[evidence-describe-table]
            EQ[evidence-query]
        end
        
        subgraph "MCP Resources"
            SR[Source Schemas]
        end
        
        D --> LS
        D --> SR
        DI --> LT
        DI --> DT
        DI --> EQ
    end
```

## Implementation Plan

### 1. Server Configuration Modifications

- Update the `Config` class:
  - Replace `db_path` with `evidence_project_path`
  - Default `readonly` to `True` and remove write capability
  - Add method to locate the `.evidence/template/static/data` directory

### 2. Data Discovery Implementation

- Create a new class for discovering Evidence.dev data:
  - Scan the project to find all parquet files
  - Parse schema files to understand data structure
  - Parse manifest.json to catalog all data sources
  - Map sources to their corresponding parquet files and schemas

### 3. DuckDB Interface Updates

- Modify the `DuckDBDatabase` class:
  - Create in-memory DuckDB connection
  - Add methods to query parquet files directly
  - Implement mapping of source queries to the appropriate parquet files
  - Remove all write functionality

### 4. MCP Tool Implementation

- Implement Evidence-specific tools:
  - `evidence-list-sources`: List all available data sources
  - `evidence-list-tables`: List all tables within a data source
  - `evidence-describe-table`: Get schema info for a specific table
  - `evidence-query`: Execute a SQL query on parquet data
  - Remove all write-related tools

### 5. Resource Implementation

- Create resources for each data source:
  - Expose schema information
  - Provide metadata about the source

### 6. Testing Strategy

- Test with different Evidence.dev projects
- Verify discovery of all data sources
- Test queries of varying complexity
- Ensure schema information is correctly presented

## Detailed File Changes

1. `src/mcp_server_duckdb/config.py`:
   - Update Config class to work with Evidence.dev project paths
   - Modify argument parser to accept project path

2. `src/mcp_server_duckdb/server.py`:
   - Add Evidence data discovery functionality
   - Modify DuckDBDatabase to work with parquet files
   - Update tool handlers with Evidence-specific names
   - Remove write functionality
   - Update resource handlers to expose source schemas

## Timeline Estimate

1. Server Configuration Modifications: 1 day
2. Data Discovery Implementation: 2 days
3. DuckDB Interface Updates: 1 day
4. MCP Tool Implementation: 2 days
5. Resource Implementation: 1 day
6. Testing and Refinement: 2 days

Total: ~9 days of development work